---
title: "Doxycyline effect"
author: "Michael Smallegan\n"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE,
        tidyverse.quiet = TRUE)
library(tidyverse)
library(DESeq2)
library(seriation)
library(apeglm)
source("../util/_plot_theme.R")
source("../util/_util.R")
source("../util/deseq.R")
source("../util/figures.R")
source("../01_setup/assumptions.R")

if(!file.exists("data")) dir.create("data")
if(!file.exists("results")) dir.create("results")
if(!file.exists("figures")) dir.create("figures")

# Keep track of thresholds for figure naming
thresh <- paste0("pval", pval_thresh, "_l2fc", round(l2fc_thresh, 2))
```

```{r load, include=FALSE}
load("../01_setup/results/rnaseq_data.RData",
     verbose = TRUE)

rnaseq_samples <- rnaseq_samples %>%
  filter(date_sequenced != "2018-09")
samples <- samples %>%
  filter(date_sequenced != "2018-09")
```

### EC KO long timecourse dox effect

```{r run-deseq-esc-ko-long}
if(!file.exists("results/esc_ko_control_long.RData")) {
  source("../util/deseq.R")
  esc_ko_control_long <- deseq_vs_zero(ct = "ESC", 
                                       tc_len = "long", 
                                       fko = "KO", 
                                       fi = "control")
  save(esc_ko_control_long, file = "results/esc_ko_control_long.RData")
}

load("results/esc_ko_control_long.RData", verbose = T)
```

```{r sig-deseq-esc-ko-long}
esc_ko_control_long <- esc_ko_control_long %>%
  mutate(sig = padj <= pval_thresh & max_abs_l2fc_shrunken > l2fc_thresh)

esc_ko_control_long_sig <- esc_ko_control_long %>% 
  filter(sig == TRUE)
```

```{r lfcplot-deseq-esc-ko-long}
## Fig. 1C
make_timecourse_lfc_plot(deseq_res = esc_ko_control_long,
                         genes_to_include = unique(esc_ko_control_long_sig$gene_id),
                         y_lim = c(-5.5,8.2),
                         draw_plot = FALSE) +
  ggtitle("Dox genes: ESC KO control long",
          subtitle = "Fig. 1C")
ggsave(paste0("figures/esc_ko_control_long_lfc_", thresh, ".pdf"), 
       height = 3, width = 3.5, useDingbats = FALSE)
```

### ESC KO short timecourse dox effect

```{r run-deseq-esc-ko-short}
if(!file.exists("results/esc_ko_control_short.RData")) {
  source("../util/deseq.R")
  esc_ko_control_short <- deseq_vs_zero(ct = "ESC", 
                                        tc_len = "short", 
                                        fko = "KO", 
                                        fi = "control")
  save(esc_ko_control_short, file = "results/esc_ko_control_short.RData")
}

load("results/esc_ko_control_short.RData", verbose = T)
```

```{r sig-deseq-esc-ko-short}
esc_ko_control_short <- esc_ko_control_short %>%
  mutate(sig = padj <= pval_thresh & max_abs_l2fc_shrunken > l2fc_thresh)

esc_ko_control_short_sig <- esc_ko_control_short %>% 
  filter(sig == TRUE)
```

```{r plot-deseq-esc-ko-short}
## Fig. 2B
make_timecourse_lfc_plot(deseq_res = esc_ko_control_short,
                         genes_to_include = unique(esc_ko_control_short_sig$gene_id),
                         draw_plot = FALSE) +
  ggtitle("Dox genes: ESC KO control short",
          subtitle = "Fig. 2B")
ggsave(paste0("figures/esc_ko_control_short_lfc_", thresh, ".pdf"), 
       height = 3, width = 3.5, useDingbats = FALSE)
```

### ESC WT long timecourse dox effect

```{r run-deseq-esc-wt-long}
if(!file.exists("results/esc_wt_control_long.RData")) {
  source("../util/deseq.R")
  esc_wt_control_long <- deseq_vs_zero(ct = "ESC", 
                                       tc_len = "long", 
                                       fko = "WT", 
                                       fi = "control")
  save(esc_wt_control_long, file = "results/esc_wt_control_long.RData")
}

load("results/esc_wt_control_long.RData", verbose = T)
```

```{r sig-deseq-esc-wt-long}
esc_wt_control_long <- esc_wt_control_long %>%
  mutate(sig = padj <= pval_thresh & max_abs_l2fc_shrunken > l2fc_thresh)

esc_wt_control_long_sig <- esc_wt_control_long %>% 
  filter(sig == TRUE)
```

```{r plot-deseq-esc-wt-long}
## Fig. S2D
make_timecourse_lfc_plot(deseq_res = esc_wt_control_long,
                         genes_to_include = unique(esc_wt_control_long_sig$gene_id),
                         y_lim = c(-5,5),
                         draw_plot = FALSE) +
  ggtitle("Dox genes: ESC WT control long",
          subtitle = "Fig. S2D")
ggsave(paste0("figures/esc_wt_control_long_lfc_", thresh, ".pdf"), 
       height = 3, width = 3.5, useDingbats = FALSE)
```

### ESC WT Short timecourse dox effect

```{r run-deseq-esc-wt-short}
if(!file.exists("results/esc_wt_control_short.RData")) {
  source("../util/deseq.R")
  esc_wt_control_short <- deseq_vs_zero(ct = "ESC", 
                                        tc_len = "short", 
                                        fko = "WT", 
                                        fi = "control")
  save(esc_wt_control_short, file = "results/esc_wt_control_short.RData")
}

load("results/esc_wt_control_short.RData", verbose = T)
```

```{r sig-deseq-esc-wt-short}
esc_wt_control_short <- esc_wt_control_short %>%
  mutate(sig = padj <= pval_thresh & max_abs_l2fc_shrunken > l2fc_thresh)

esc_wt_control_short_sig <- esc_wt_control_short %>% 
  filter(sig == TRUE)
```

```{r plot-deseq-esc-wt-short}
## Fig. S4C.
make_timecourse_lfc_plot(deseq_res = esc_wt_control_short,
                         genes_to_include = unique(esc_wt_control_short_sig$gene_id),
                         draw_plot = FALSE) +
    ggtitle("Dox genes: ESC WT control short",
          subtitle = "Fig. S4C")
ggsave(paste0("figures/esc_wt_control_short_lfc_", thresh, ".pdf"), 
       height = 3, width = 3.5, useDingbats = FALSE)
```
---
title: "ATAC-seq"
author: "Michael Smallegan"
date: "9/29/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DESeq2)
source("../util/_plot_theme.R")

```

```{r}
# Import data
atac_consensus <- read.table("../../atacseq/results/bwa/mergedLibrary/macs/broadPeak/consensus/consensus_peaks.mLb.clN.annotatePeaks.txt", sep = "\t", header = T)
atac_consensus_boolean <- read.table("../../atacseq/results/bwa/mergedLibrary/macs/broadPeak/consensus/consensus_peaks.mLb.clN.boolean.annotatePeaks.txt", sep = "\t", header = T)
colnames(atac_consensus_boolean)
atac_consensus_boolean$ESC_KO_control_120_R1.mLb.clN.fc

atac_c_fc <- read.table("../../atacseq/results/bwa/mergedLibrary/macs/broadPeak/consensus/consensus_peaks.mLb.clN.featureCounts.txt", skip = 1, sep = "\t", header = T)

```

```{r}
# Let's run a linear model and determine which peaks are different about
# Apparently this consensus peak approach is prone to false positives
# https://support.bioconductor.org/p/108458/#108469
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4066778/
# https://support.bioconductor.org/p/109154/
colnames(atac_c_fc) <- gsub(".mLb.clN.bam","",colnames(atac_c_fc))
rownames(atac_c_fc) <- atac_c_fc$Geneid
interval_table <- atac_c_fc[,1:6]
counts <- atac_c_fc[,7:ncol(atac_c_fc),drop=FALSE] %>% as.matrix()

samples <- data.frame("sample_name" = colnames(counts)) %>%
  mutate(sample_name = gsub("firre_induced", "firreinduced", sample_name)) %>%
  separate(sample_name, into = c("cell_type", "firre_ko", "firre_induced", "timepoint_minutes", "replicate"), remove = FALSE) %>%
  mutate(sample_name = gsub("firreinduced", "firre_induced", sample_name),
         firre_induced = gsub("firreinduced", "firre_induced", firre_induced)) %>%
  dplyr::select(-replicate)

samples$firre_ko <- factor(samples$firre_ko, levels = c("WT", "KO"))
samples$firre_induced <- factor(samples$firre_induced, levels = c("control", "firre_induced"))
samples$timepoint_minutes <- factor(samples$timepoint_minutes, 
                                    levels = seq(0,150,30))
rownames(samples) <- samples$sample_name

stopifnot(all(colnames(counts) == rownames(samples)))


```

```{r}
## FULL MODEL
design_formula <- formula(paste0("~ timepoint_minutes + firre_induced + firre_ko +",
                                   "firre_induced*timepoint_minutes"))
## REDUCED MODEL
reduced_formula <- formula("~ timepoint_minutes + firre_induced + firre_ko")

dds <- DESeqDataSetFromMatrix(countData = round(counts), 
                               colData = samples, 
                               design = design_formula)

dds <- DESeq(dds, test="LRT", 
             reduced = reduced_formula)

(res_names <- resultsNames(dds))

res <- results(dds, name = res_names[2]) %>% 
    as.data.frame() %>%
    rownames_to_column(var = "interval_id") %>%
    mutate(result_name = res_names[2]) 

 for(i in 3:length(res_names)) {
    tmp_res <- results(dds, 
                       name = res_names[i]) %>%
      as.data.frame() %>%
      rownames_to_column(var = "interval_id") %>%
      mutate(result_name = res_names[i]) 
    res <- bind_rows(res, tmp_res)
 }

write_csv(res, "results/atac_timecourse_de.csv")

sig_res <- res %>% filter(padj < 0.1)
```




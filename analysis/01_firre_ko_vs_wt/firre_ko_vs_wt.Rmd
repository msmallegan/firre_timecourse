---
title: "Firre knockout vs wildtype"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE,
        tidyverse.quiet = TRUE)
library(tidyverse)
library(DESeq2)
source("../util/_plot_theme.R")
```

```{r}
load("../00_setup/results/rnaseq_data.RData")

esc_samples <- samples %>% 
  filter(cell_type == "ESC", timepoint == 0, timecourse_length == "long") %>%
  mutate(firre_ko = factor(firre_ko, levels = c("WT", "KO")))
rownames(esc_samples) <- esc_samples$sample_id
# firre_ko + firre_induced + experiment_replicate + timecourse_length
esc_counts <- salmon_gene_counts[,as.character(esc_samples$sample_id)]

genes <- genes[genes$gene_id %in% rownames(esc_counts),]
esc_counts <- esc_counts[genes$gene_id,]

stopifnot(all(rownames(esc_samples) == colnames(esc_counts)))

esc_samples$experiment_replicate <- factor(esc_samples$experiment_replicate)

esc_dds <- DESeqDataSetFromMatrix(countData = esc_counts, 
                                colData = esc_samples, 
                                design = ~ firre_ko + firre_induced)
esc_dds <- DESeq(esc_dds)

res_names <- resultsNames(esc_dds)
esc_res <- results(esc_dds, 
               name = "firre_ko_KO_vs_WT")


esc_resdf <- esc_res %>% as.data.frame() %>%
  rownames_to_column("gene_id") %>% 
  merge(g2s)

ggplot(esc_resdf %>% filter(!is.na(padj)), aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point()

sig_res <- esc_resdf %>% filter(padj < 0.05, abs(log2FoldChange) > 1)
# sig_res <- esc_resdf %>% filter(padj < 0.05)
long_zero_res <- sig_res
ltc_samples <- samples %>% 
  filter(cell_type == "ESC", 
         # timepoint %in% c(0,720), 
         timecourse_length == "long",
         firre_ko == "KO")

gfap <- tpm %>% filter(gene_name == "Dazl") %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(ltc_samples) %>%
  filter(!is.na(experiment_replicate))
ggplot(gfap, aes(x = timepoint, y = tpm, color = firre_induced)) +
  geom_jitter(width = 0.1)

```

```{r}
ltc_samples <- samples %>% 
  filter(cell_type == "ESC",
         timecourse_length == "long",
         firre_ko == "KO")
rownames(ltc_samples) <- ltc_samples$sample_id
# firre_ko + firre_induced + experiment_replicate + timecourse_length
ltc_counts <- salmon_gene_counts[,as.character(ltc_samples$sample_id)]

genes <- genes[genes$gene_id %in% rownames(ltc_counts),]
ltc_counts <- ltc_counts[genes$gene_id,]

stopifnot(all(rownames(ltc_samples) == colnames(ltc_counts)))

ltc_samples$experiment_replicate <- factor(ltc_samples$experiment_replicate)

ltc_dds <- DESeqDataSetFromMatrix(countData = ltc_counts, 
                                colData = ltc_samples, 
                                design = ~ firre_induced + timepoint + timepoint*firre_induced)
ltc_dds <- DESeq(ltc_dds, test = "LRT", reduced = ~ firre_induced + timepoint)
# ltc_dds <- DESeq(ltc_dds)
# ltc_dds <- DESeq(ltc_dds, test = "LRT", reduced = ~ 1)
res_names <- resultsNames(ltc_dds)
ltc_res <- results(ltc_dds, 
               name = "timepoint_5760_vs_0")


ltc_resdf <- ltc_res %>% as.data.frame() %>%
  rownames_to_column("gene_id") %>% 
  merge(g2s)

ggplot(ltc_resdf %>% filter(!is.na(padj)), aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point()

ltc_sig_res <- ltc_resdf %>% filter(padj < 0.05)


length(which(ltc_sig_res$gene_id %in% long_zero_res$gene_id))

hmm <- ltc_sig_res[which(ltc_sig_res$gene_id %in% long_zero_res$gene_id),] %>%
  dplyr::select(gene_id, gene_name, log2FoldChange) %>%
  dplyr::rename(l2fc_ltc = log2FoldChange) 
huh <- long_zero_res[which(long_zero_res$gene_id %in% ltc_sig_res$gene_id),] %>%
  dplyr::select(gene_id, gene_name, log2FoldChange) %>%
  dplyr::rename(l2fc_zero = log2FoldChange) 

combined <- hmm %>% left_join(huh)

ggplot(combined, aes(x = l2fc_zero, y = l2fc_ltc, label = gene_name)) +
  geom_point() +
  # geom_text_repel() +
  geom_abline(slope = -1) +
  xlim(-4,4) +
  ylim(-4,4)
```


```{r}
# Make a damn heatmap
goi <- ltc_sig_res$gene_id[ltc_sig_res$gene_id %in% long_zero_res$gene_id]
goi_names <- ltc_sig_res$gene_name[ltc_sig_res$gene_id %in% long_zero_res$gene_id]
tpm_goi <- tpm %>% filter(gene_id %in% goi) %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(esc_samples) %>%
filter(!is.na(experiment_replicate)) 
wtko_matrix <- tpm_goi %>%
  group_by(gene_name, firre_ko) %>%
  summarize(tpm = mean(tpm)) %>%
  pivot_wider(names_from = "firre_ko", 
              values_from = "tpm")

ltc_last_samples <- samples %>% 
  filter(cell_type == "ESC",
         timecourse_length == "long",
         firre_ko == "KO",
         timepoint != 0)
tpm_goi_ltc <- tpm %>% filter(gene_id %in% goi) %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(ltc_last_samples) %>%
filter(!is.na(experiment_replicate)) 
ltc_matrix <- tpm_goi_ltc %>%
  group_by(gene_name, timepoint) %>%
  summarize(tpm = mean(tpm)) %>%
  pivot_wider(names_from = "timepoint", 
              values_from = "tpm")

comb_matrix <- wtko_matrix %>% left_join(ltc_matrix) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

comb_matrix_scaled <- t(scale(t(comb_matrix)))

library(seriation)
?olo

cl_cb <- function(hcl, mat){
    # Recalculate manhattan distances for reorder method
    dists <- dist(mat, method = "euclidean")

    # Perform reordering according to OLO method
    hclust_olo <- reorder(hcl, dists)
    return(hclust_olo)
}
pdf("figures/longtimecourse_rescue.pdf", width = 3.5, height = 4)
pheatmap::pheatmap(comb_matrix_scaled, cluster_cols = FALSE, cluster_rows = TRUE, show_rownames = TRUE,
                   color = col_pal10,
                   clustering_callback = cl_cb,
                   clustering_distance_rows = "euclidean",
                   border_color = NA,
                    fontsize_row = 8,
                   breaks = seq(-1.5, 1.5, length.out = length(col_pal10)),
                   treeheight_row = 25)
dev.off()

pc_dat <- prcomp(t(comb_matrix_scaled))
summary(pc_dat)
pc_df <- pc_dat$x[,1:2] %>%
  as.data.frame() %>%
  rownames_to_column("sample")
pc_dat$sdev
ggplot(pc_df, aes(x = PC1, y = PC2, label = sample)) +
  geom_point() +
  geom_text_repel()
ggsave("figures/longtimecourse_pca.pdf", width = 3.5, height = 0.9, useDingbats = FALSE)

```

```{r}
ltc_samples <- samples %>% 
  filter(cell_type == "ESC",
         timecourse_length == "long",
         firre_ko == "KO",
         timepoint %in% c(0,720))
rownames(ltc_samples) <- ltc_samples$sample_id
# firre_ko + firre_induced + experiment_replicate + timecourse_length
ltc_counts <- salmon_gene_counts[,as.character(ltc_samples$sample_id)]

genes <- genes[genes$gene_id %in% rownames(ltc_counts),]
ltc_counts <- ltc_counts[genes$gene_id,]

stopifnot(all(rownames(ltc_samples) == colnames(ltc_counts)))

ltc_samples$experiment_replicate <- factor(ltc_samples$experiment_replicate)

ltc_dds <- DESeqDataSetFromMatrix(countData = ltc_counts, 
                                colData = ltc_samples, 
                                design = ~ firre_induced + timepoint + timepoint*firre_induced)
ltc_dds <- DESeq(ltc_dds, test = "LRT", reduced = ~ firre_induced + timepoint)
# ltc_dds <- DESeq(ltc_dds)
# ltc_dds <- DESeq(ltc_dds, test = "LRT", reduced = ~ 1)
res_names <- resultsNames(ltc_dds)
ltc_res <- results(ltc_dds, 
               name = "firre_inducedfirre_induced.timepoint720")


ltc_resdf <- ltc_res %>% as.data.frame() %>%
  rownames_to_column("gene_id") %>% 
  merge(g2s)

ggplot(ltc_resdf %>% filter(!is.na(padj)), aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point()

ltc_sig_res <- ltc_resdf %>% filter(padj < 0.05, abs(log2FoldChange) > 1)


length(which(ltc_sig_res$gene_id %in% long_zero_res$gene_id))

hmm <- ltc_sig_res[which(ltc_sig_res$gene_id %in% long_zero_res$gene_id),] %>%
  dplyr::select(gene_id, gene_name, log2FoldChange) %>%
  dplyr::rename(l2fc_ltc = log2FoldChange) 
huh <- long_zero_res[which(long_zero_res$gene_id %in% ltc_sig_res$gene_id),] %>%
  dplyr::select(gene_id, gene_name, log2FoldChange) %>%
  dplyr::rename(l2fc_zero = log2FoldChange) 

combined <- hmm %>% left_join(huh)

ggplot(combined, aes(x = l2fc_zero, y = l2fc_ltc, label = gene_name)) +
  geom_point() +
  # geom_text_repel() +
  geom_abline(slope = -1) +
  xlim(-4,4) +
  ylim(-4,4)
```

Traditionally, the logic has been that genes that are changing reciprocally in a knockout and rescue experiment are direct targets of a lncRNA acting in trans to regulate genes. However, those genes may be the steady state reached after waves of successive gene regulatory events. How do you know what timescale to look at to detect changes? When is the steady state reached?
It appears that for the genes that are reciprocally regulated by Firre, 12h is not enough, but it’s a wash after that. >24h all move closer in appearance to WT when Firre is induced in a knockout.
Surprise! However, this is a completely different set of genes than is regulated by Firre quickly in the short 6h timecourse. Another surprise! Firre’s early dynamics (going up and then down, etc.)


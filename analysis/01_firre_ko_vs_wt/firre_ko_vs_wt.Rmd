---
title: "Firre knockout vs wildtype"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE,
        tidyverse.quiet = TRUE)
library(tidyverse)
library(DESeq2)
library(seriation)
source("../util/_plot_theme.R")
source("../util/_util.R")
```

```{r load, include=FALSE}
load("../00_setup/results/rnaseq_data.RData")
```

```{r thresholds}
pval_thresh <- 0.05
l2fc_thresh <- 1
```

# Static Firre knockout vs wildtype

The cell lines derived from the mouse have had a lot of time to equilibrate to the effect of the loss of the Firre locus. This is a true static snapshot of the state of the cell without Firre.

```{r wtko}
# NOTE: The short timecourse had WT and KO cell lines
# sequenced at different times. Therefore, it is 
# Better to use the results of the long timecourse
# to compare KO vs WT.
wtko_samples <- samples %>% 
  filter(cell_type == "ESC", 
         timepoint == 0, 
         timecourse_length == "long")

wtko_counts <- salmon_gene_counts[,wtko_samples$sample_id]

# Check the ordering
stopifnot(all(rownames(wtko_samples) == colnames(wtko_counts)))
stopifnot(all(rownames(wtko_counts) == genes$gene_id))

# DESeq2
wtko_dds <- DESeqDataSetFromMatrix(countData = wtko_counts, 
                                   colData = wtko_samples, 
                                   design = ~ firre_ko)
wtko_dds <- DESeq(wtko_dds)

# Results
wtko_res <- results(wtko_dds, name = "firre_ko_KO_vs_WT") %>% 
  as.data.frame() %>%
  rownames_to_column("gene_id") %>% 
  merge(g2s) %>%
  mutate(sig = padj <= pval_thresh & abs(log2FoldChange) > l2fc_thresh)

wtko_sig <- wtko_res %>% 
  filter(sig == TRUE)
```

```{r wtko_plots}
ggplot(wtko_res %>% filter(!is.na(padj)), 
       aes(x = padj)) +
  geom_histogram(bins = 30)

# Number of DEG
wtko_num_deg <- wtko_res %>%
  filter(sig == TRUE) %>%
  mutate(direction = ifelse(log2FoldChange > 0, "up", "down")) %>%
  group_by(direction) %>%
  summarize(num_deg = n())

ggplot(wtko_res %>% filter(!is.na(padj)), 
       aes(x = log2FoldChange, y = -log10(padj), color = sig)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 1, lty = 2) +
  geom_vline(xintercept = -1, lty = 2) +
  geom_hline(yintercept = -log10(pval_thresh), lty = 2) +
  geom_point(data = wtko_res %>% filter(sig == TRUE), size = 1)  +
  geom_point(data = wtko_res %>% filter(sig == FALSE, !is.na(padj)), size = 1, alpha = 0.7) +
  annotate("text", x = 4, y = 100, label = paste0("n = ", wtko_num_deg %>% filter(direction == "up") %>%
             pull(num_deg))) +
   annotate("text", x = -4, y = 100, label = paste0("n = ", wtko_num_deg %>% filter(direction == "down") %>%
             pull(num_deg))) +
  geom_text_repel(data = wtko_res %>% filter(gene_name == "Firre"), aes(label = gene_name)) +
  theme(legend.position = "none")
ggsave("figures/firre_ko_wt_volcano.pdf", height = 3, width = 3, useDingbats = FALSE)

ggplot(wtko_res %>% filter(!is.na(padj)), 
       aes(x = log10(baseMean), y = log2FoldChange, color = sig)) +
  geom_hline(yintercept = 0) +
  geom_point(data = wtko_res %>% filter(sig == TRUE), size = 1)  +
  geom_point(data = wtko_res %>% filter(sig == FALSE, !is.na(padj)), size = 1, alpha = 0.7) +
  geom_text_repel(data = wtko_res %>% filter(gene_name == "Firre"), aes(label = gene_name)) +
  theme(legend.position = "none")
ggsave("figures/firre_ko_wt_ma.pdf", height = 3, width = 3, useDingbats = FALSE)

```

# Firre induction rescue experiment

For this experiment, we induced the expression of Firre with an rTTA element by adding doxycycline to the cells. We see that Firre is indeed expressed in the KO background after the addition of doxycycline. The drug does instigate some gene expression changes on its own, so we will control for the effects by using a linear model which accounts for the effect of dox.

```{r long_timecourse}
# Filter to ESC KO long timecourse
ko_rescue_samples <- samples %>%
  filter(cell_type == "ESC",
         timecourse_length == "long",
         firre_ko == "KO")
ko_rescue_counts <- salmon_gene_counts[,ko_rescue_samples$sample_id]

# Check ordering
stopifnot(all(rownames(ko_rescue_samples) == colnames(ko_rescue_counts)))
stopifnot(all(rownames(ko_rescue_counts) == genes$gene_id))

# DESeq2 -- controlling for doxycycline; likelihood ratio test
ko_rescue_dds <- DESeqDataSetFromMatrix(countData = ko_rescue_counts, 
                                        colData = ko_rescue_samples, 
                                        design = ~ firre_induced + timepoint + timepoint*firre_induced)
ko_rescue_dds <- DESeq(ko_rescue_dds, test = "LRT", reduced = ~ firre_induced + timepoint)

# Compile results
res_names <- resultsNames(ko_rescue_dds)
dynamic_res <- res_names[grepl("firre_inducedfirre_induced.timepoint", res_names)]

ko_rescue_res <- lapply(dynamic_res, function(x) {
  results(ko_rescue_dds, 
          name = x) %>%
    as.data.frame() %>%
    rownames_to_column("gene_id") %>% 
    merge(g2s) %>%
    mutate(result_name = x,
           timepoint = as.numeric(gsub("firre_inducedfirre_induced.timepoint", "", result_name)))
}) %>% bind_rows()

# Calculate the maximum fold-change in any one timepoint
ko_rescue_maxfc <-  ko_rescue_res %>%
  group_by(gene_id) %>%
  summarize(max_fc = max(abs(log2FoldChange))) 
ko_rescue_res <- ko_rescue_res %>%
  left_join(ko_rescue_maxfc) %>%
  mutate(sig = padj <= pval_thresh & max_fc > l2fc_thresh)

ko_rescue_sig <- ko_rescue_res %>% 
  filter(sig == TRUE)
```

```{r}
# Heatmap of fold-changes for DEGs in the rescue
# Check that there are no duplicate row names.
stopifnot(all(length(unique(ko_rescue_sig$gene_id)) == length(unique(ko_rescue_sig$gene_name))))
ko_rescue_lfc <- ko_rescue_sig %>%
  dplyr::select(gene_name, timepoint, log2FoldChange) %>%
  pivot_wider(names_from = timepoint, names_sort = TRUE, values_from = log2FoldChange) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()
# Add a zero column.
ko_rescue_lfc <- cbind(matrix(0, nrow = nrow(ko_rescue_lfc), ncol = 1), ko_rescue_lfc)
colnames(ko_rescue_lfc)[[1]] <- "0"

pdf("figures/ltc_rescue_heatmap.pdf", width = 3, height = 7)
pheatmap::pheatmap(ko_rescue_lfc, cluster_cols = FALSE, 
                   color = col_pal10, border_color = NA,
                    breaks = seq(-3.5, 3.5, length.out = length(col_pal10)),
                   fontsize_row = 8)
dev.off()
```


# Firre rescued genes

We can visualize the expression levels of the genes that were significantly differentially expressed in the Firre knockout and dynamically changing in response to Firre's induction in a knockout background.

```{r rescue_heatmap}
# Retrieve the set of genes that is DE in the KO and is significantly changing
# in the KO rescue experiment. 
rescued_genes <- wtko_sig$gene_id[wtko_sig$gene_id %in% (ko_rescue_res %>% 
                                                           filter(padj <= pval_thresh) %>% pull(gene_id))]


# Retrieve the TPM -- take the mean TPM in each condition.
wtko_matrix <- tpm %>% 
  filter(gene_id %in% rescued_genes) %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(wtko_samples) %>%
  drop_na() %>%
  group_by(gene_name, firre_ko) %>%
  summarize(tpm = mean(tpm)) %>%
  pivot_wider(names_from = "firre_ko", 
              values_from = "tpm")

ko_rescue_matrix <- tpm %>% 
  filter(gene_id %in% rescued_genes) %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(ko_rescue_samples) %>%
  drop_na() %>%
  filter(timepoint != 0) %>%
  group_by(gene_name, timepoint) %>%
  summarize(tpm = mean(tpm)) %>%
  pivot_wider(names_from = "timepoint", 
              values_from = "tpm")

comb_matrix <- wtko_matrix %>% 
  left_join(ko_rescue_matrix) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

comb_matrix_scaled <- t(scale(t(comb_matrix)))
```

```{r rescue_heatmap}
pdf("figures/longtimecourse_rescue.pdf", width = 3.5, height = 4)
pheatmap::pheatmap(comb_matrix_scaled, cluster_cols = FALSE, cluster_rows = TRUE, show_rownames = TRUE,
                   color = col_pal10,
                   clustering_callback = olo_seriate,
                   clustering_distance_rows = "euclidean",
                   border_color = NA,
                   fontsize_row = 8,
                   breaks = seq(-1.5, 1.5, length.out = length(col_pal10)),
                   treeheight_row = 25)
dev.off()
```

```{r rescue_pca}
pca_dat <- prcomp(t(comb_matrix))
proportion_of_variance <- summary(pca_dat)$importance[2,1:2]

pca_df <- pca_dat$x[,1:2] %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  mutate(PC1 = PC1 * -1)

ggplot(pca_df, aes(x = PC1, y = PC2, label = sample)) +
  geom_point() +
  geom_text_repel() +
  xlab(paste0("PC1: ", round(proportion_of_variance["PC1"]*100), "%")) +
  ylab(paste0("PC2: ", round(proportion_of_variance["PC2"]*100), "%"))
ggsave("figures/longtimecourse_pca.pdf", 
       width = 3.5, height = 0.9, 
       useDingbats = FALSE)
```

# Firre's induction

We would like to check that Firre's expression is actually induced by the addition of
doxycycline. 

```{r firre_profile}
firre_ko_rescue <- tpm %>%
  filter(gene_name == "Firre") %>%
  pivot_longer(3:ncol(.), names_to = "sample_id", values_to = "tpm") %>%
  left_join(samples) %>%
  filter(cell_type == "ESC", firre_ko == "KO", timecourse_length == "long")

firre_means <- firre_ko_rescue %>%
  group_by(timepoint, firre_induced) %>%
  summarize(tpm = mean(tpm)) %>%
  mutate(timepoint = as.numeric(as.character(timepoint)))
ggplot(firre_ko_rescue, 
       aes(x = as.numeric(as.character(timepoint)), y = tpm, color = firre_induced)) +
  geom_line(data = firre_means, aes(x = timepoint, y = tpm, color = firre_induced,
                                    group = firre_induced)) +
  geom_point() + 
  theme(legend.position = "none") +
  xlab("T (min)")
ggsave("figures/firre_esc_ko_profile.pdf", height = 3, width = 3, useDingbats = FALSE)

```

---
title: "Identifying Firre responder genes"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Identifying Firre responder genes
### Firre induction vs control differential expression analysis

In this script we will analyze four experimental conditions to indentify
Firre responders and then look at the overlap in the responders across 
conditions.
We have two cell types and two genetic backgrounds for each: ESC - embryonic
stem cells, NPC - neural precursor cells and Firre KO and WT for each cell type.
In each genetic background (Firre KO & WT) we have a genomically incorporated
Firre transgene under the control of an rtTA (reverse tetracycline-controlled 
transactivator) element.
We will test whether turning on the expression of the Firre transgene (by adding
doxycycline) results in a gene being differentially expressed in comparison 
to the condition in which doxycycline is added, but Firre expression is 
not induced. Here we'll use the Likelihood ratio test from the DEseq2 package
to test whether Firre induces a change in gene expression any time after the 
zero timepoint. 

Briefly, we will use the likelihood ratio test to compare the fit for a model 
containing the time factor,
condition factor, and an interaction term to a reduced model without the 
interaction term: `time + firre_induced + time*firre_induced` vs 
`time + firre_induced`. The coefficients of the interaction term will 
give us the profile of the gene's expression relative to the control samples. 

Since it is likely that the genes influenced by Firre may change based on 
the genetic background and cell state, we will analyze each cell type and 
genotype separately. While the genes changing in each individual experiment
may be true Firre targets in that context, by comparing across contexts,
we will arrive at a set of genes that is robustly and reproducibly 
regulated by Firre. 

We will use the gene counts generated by Salmon	v0.14.1 (a la the
nf-core/rnaseq	v1.4.2 pipeline) using Gencode vM25 annotations and the mm10
reference genome.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE,
        tidyverse.quiet = TRUE)
library(tidyverse)
library(DESeq2)
library(gplots)
library(ggrepel)
library(ggpubr)
source("../util/_plot_theme.R")
source("../util/_util.R")
```

```{r import}
### ANNOTATIONS
if(!file.exists("../util/gencode.vM25.annotation.genes.gtf")) {
  gencode <- rtracklayer::import(file.path("../../../../genomes/Mus_musculus/",
                                           "Gencode/M25/",
                                           "gencode.vM25.annotation.gtf"))
  genes <- gencode[gencode$type == "gene"]
  rtracklayer::export(genes, 
                      "../util/gencode.vM25.annotation.genes.gtf")
}
genes <- rtracklayer::import(file.path("../util/",
                                       "gencode.vM25.annotation.genes.gtf"))
names(genes) <- genes$gene_id

g2s <- genes %>% as.data.frame() %>%
  dplyr::select(gene_id, gene_name)

tx2gene <- read.csv("../../rnaseq/results/salmon/tx2gene.csv")

### COUNTS
tpm <- read.csv("../../rnaseq/results/salmon/salmon_merged_gene_tpm.csv") %>%
  merge(g2s) %>%
  dplyr::select(gene_id, gene_name, everything())

salmon_gene_counts <- read.csv(file.path("../../rnaseq/results/salmon/",
                                         "salmon_merged_gene_counts.csv")) %>%
  column_to_rownames("gene_id") %>%
  as.matrix()
mode(salmon_gene_counts) <- "integer"

# Put in order
genes <- genes[rownames(salmon_gene_counts)]

### SAMPLE INFO
samples <- read.csv("../../rnaseq/rnaseq_samplesheet.csv") %>%
  filter(cell_type != "pMEF",
         date_sequenced != "2018-09",
         timecourse_length == "short") %>%
  mutate(firre_ko = factor(firre_ko, levels = c("WT", "KO")),
         timepoint = factor(timepoint, 
                            levels = c(seq(0,360,30))),
         firre_induced = factor(firre_induced, 
                                levels = c("control", "firre_induced")))
rownames(samples) <- samples$sample_id
```

### DEseq2 -- WT and KO separate

```{r deseq2}
# Since this takes a while to run, we'll cache this part
if(!file.exists("results/deseq_res.csv")) {
  
  ## FULL MODEL
  design_formula <- formula(paste0("~ timepoint + firre_induced + ",
                                   "firre_induced*timepoint"))
  ## REDUCED MODEL
  reduced_formula <- formula("~ timepoint + firre_induced")
  
  ## EXPERIMENTS
  # We're going to make 4 comparisons
  experiments <- c("ESC_KO","ESC_WT", "NPC_KO", "NPC_WT")
  
  ## RUN DESEQ2
  deseq_res <- lapply(experiments, run_timecourse_deseq,
                      counts = salmon_gene_counts, 
                      samples = samples,
                      genes = genes,
                      design_formula = design_formula,
                      reduced_formula = reduced_formula,
                      independent_filtering = FALSE)
  
  res_list <- lapply(deseq_res, "[[","res")
  res_shrunken_list <- lapply(deseq_res, "[[","res_shrunken")
  
  resdf <- bind_rows(res_list)
  write_csv(resdf, "results/deseq_res.csv")
  res_shrunkendf <- bind_rows(res_shrunken_list)
  write_csv(res_shrunkendf, "results/deseq_res_shrunken.csv")
}

resdf <- read.csv("results/deseq_res.csv")
res_shrunkendf <- read.csv("results/deseq_res_shrunken.csv")
```

### DEseq2 -- Combined model

```{r}
## Let's run the DEseq2 on the combined model

esc_samples <- samples %>% filter(cell_type == "ESC")
esc_counts <- salmon_gene_counts[,esc_samples$sample_id]

dds <- DESeqDataSetFromMatrix(countData = esc_counts, 
                              colData = esc_samples, 
                              design = formula("~ firre_ko + timepoint + firre_induced + firre_induced*timepoint"),
                              rowData = genes)

dds <- DESeq(dds, 
             test="LRT", 
             reduced = ~ firre_ko + timepoint + firre_induced,
             parallel=TRUE,
             BPPARAM=MulticoreParam(12))

res_names <- resultsNames(dds)
res <- results(dds, name = res_names[2]) 
  
res_shrunken <- lfcShrink(dds = dds,
                          coef = res_names[2],
                          res = res,
                          type = "apeglm",
                          parallel = TRUE,
                          BPPARAM=MulticoreParam(12)) %>% 
  as.data.frame() %>%
  rownames_to_column(var = "gene_id") %>%
  merge(g2s) %>%
  mutate(result_name = res_names[2]) 
  
  
# Convert to data frame
res <- res %>% 
  as.data.frame() %>%
  rownames_to_column(var = "gene_id") %>%
  merge(g2s) %>%
  mutate(result_name = res_names[2]) 

for(i in 3:length(res_names)) {
  tmp_res <- results(dds, 
                     name = res_names[i])
  
  tmp_res_shrunken <- suppressMessages(lfcShrink(dds = dds,
                                                 coef = res_names[i],
                                                 res = tmp_res,
                                                 type = "apeglm",
                                                 parallel = TRUE,
                                                 BPPARAM=MulticoreParam(ncores))) %>%
    as.data.frame() %>%
    rownames_to_column(var = "gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = res_names[i]) 
  
  tmp_res <- tmp_res %>% 
    as.data.frame() %>%
    rownames_to_column(var = "gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = res_names[i]) 
  
  res_shrunken <- bind_rows(res_shrunken, tmp_res_shrunken)
  res <- bind_rows(res, tmp_res)
}

write_csv(res, "results/combined_esc_deg.csv")
write_csv(res_shrunken, "results/combined_esc_deg_shrunken.csv")
```

```{r}
# NPC combined model
npc_samples <- samples %>% filter(cell_type == "NPC")
npc_counts <- salmon_gene_counts[,npc_samples$sample_id]
genes <- genes[rownames(npc_counts)]

dds <- DESeqDataSetFromMatrix(countData = npc_counts, 
                              colData = npc_samples, 
                              design = formula("~ firre_ko + timepoint + firre_induced + firre_induced*timepoint"),
                              rowData = genes)

dds <- DESeq(dds, 
             test="LRT", 
             reduced = ~ firre_ko + timepoint + firre_induced,
             parallel=TRUE,
             BPPARAM=MulticoreParam(12))

res_names <- resultsNames(dds)
res <- results(dds, name = res_names[2]) 
  
res_shrunken <- lfcShrink(dds = dds,
                          coef = res_names[2],
                          res = res,
                          type = "apeglm",
                          parallel = TRUE,
                          BPPARAM=MulticoreParam(12)) %>% 
  as.data.frame() %>%
  rownames_to_column(var = "gene_id") %>%
  merge(g2s) %>%
  mutate(result_name = res_names[2]) 
  
  
# Convert to data frame
res <- res %>% 
  as.data.frame() %>%
  rownames_to_column(var = "gene_id") %>%
  merge(g2s) %>%
  mutate(result_name = res_names[2]) 

for(i in 3:length(res_names)) {
  tmp_res <- results(dds, 
                     name = res_names[i])
  
  tmp_res_shrunken <- suppressMessages(lfcShrink(dds = dds,
                                                 coef = res_names[i],
                                                 res = tmp_res,
                                                 type = "apeglm",
                                                 parallel = TRUE,
                                                 BPPARAM=MulticoreParam(ncores))) %>%
    as.data.frame() %>%
    rownames_to_column(var = "gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = res_names[i]) 
  
  tmp_res <- tmp_res %>% 
    as.data.frame() %>%
    rownames_to_column(var = "gene_id") %>%
    merge(g2s) %>%
    mutate(result_name = res_names[i]) 
  
  res_shrunken <- bind_rows(res_shrunken, tmp_res_shrunken)
  res <- bind_rows(res, tmp_res)
}

write_csv(res, "results/npc_combined_esc_deg.csv")
write_csv(res_shrunken, "results/npc_combined_esc_deg_shrunken.csv")

npc_sig <- res %>% filter(padj < 0.05)
```

```{r}
# HMM
# https://cells.ucsc.edu/?ds=cortex-dev&gene=SHF
# https://cells.ucsc.edu/cortex-dev/exprMatrix.tsv.gz
hmm <- read_tsv("data/exprMatrix.tsv")
sg <- tolower(sig_genes$gene_name)
hmm_sig <- hmm[tolower(hmm$gene) %in% c(sg, "gpr56", "eg667281", "epo", "epp", "epxd", "eper"),]

sg[!(sg %in% tolower(hmm_sig$gene))]

hmm_sig <- hmm_sig[,c(TRUE,colSums(hmm_sig[,2:ncol(hmm_sig)]) > 0)]
colnames(hmm_sig)[1]


hmm_sig <- hmm_sig %>% column_to_rownames("gene") %>%
  as.matrix()

log2(hmm_sig[1:10,1:10])
hmm_sig_scaled <- t(scale(t(log10(hmm_sig + 1)), center = T))
summary(hmm_sig_scaled["FIRRE",])
log10(1)
table(hmm_sig_scaled["FIRRE",] > 1)
hmm_firre <- hmm_sig_scaled[,hmm_sig_scaled["FIRRE",] > 0]
summary(colSums(hmm_sig_scaled))
summary(rowSums(hmm_sig_scaled))
pheatmap::pheatmap(hmm_sig_scaled, show_colnames = FALSE)

# https://cells.ucsc.edu/cbl-dev/exprMatrix.tsv.gz
# https://cells.ucsc.edu/early-brain/exprMatrix.tsv.gz
```


```{r}
res <- read_csv("results/combined_esc_deg.csv")
hmm <- res %>% filter(padj < 0.05)
# length(unique(hmm$gene_id))
combined_model_sig <- res_shrunken %>% filter(padj < 0.05)

# Let's make some plots with these using the vs_zero fold-changes.
res_vs_zero_shrunken <- read_csv("../08_vs_zero/results/vs_zero_deseq_res_shrunken.csv")
sig_vs_zero <- res_vs_zero_shrunken %>% filter(gene_id %in% combined_model_sig$gene_id)

```


```{r}

# Let's plot these in a heatmap
sig_fc <- res %>% filter(padj < 0.05, grepl("firre_inducedfirre_induced", result_name)) %>%
  filter(gene_id %in% sig_genes$gene_id) %>%
  mutate(timepoint = gsub("timepoint|.firre_inducedfirre_induced", "", result_name) %>% as.numeric())

ggplot(sig_fc, aes(x = timepoint, y = log2FoldChange, group = gene_id)) + geom_point() + geom_line()
ggplot(sig_fc, aes(x = log10(baseMean), y = -log10(padj))) + geom_point() + 
  geom_text(data = sig_fc %>% filter(padj < 1e-3), aes(label=gene_name))
```

I'm trying to figure out what to plot in the heatmap
the options are
1. full model coefficients for the interaction term
2. mean tpm for that timepoint in the firre induction. (z-score)
3. The fitted model from the impulse fitting
4. the shrunken fold-changes from the zero timepoint.

I'm also trying to figure out whether to make a fold-change cutoff in addition to padj < 0.05
the options are
1. no fold change cutoff
2. fold-change cutoff based on the last timetpoint
3. fold-change cutoff based on the max fold change
4. fold-change cutoff based on consecutive run in the same direction.

# I'll try first the cutoff based on the last timepoint

```{r}
sig_genes <- sig_fc %>% filter(timepoint == 330, abs(log2FoldChange) > 1)



atac_peaks <- read_csv("../07_atacseq/results/atac_merged_deseq.csv") %>%
  filter(padj < 0.05)

atac_peaks_gr <- GRanges(seqnames = atac_peaks$Chr,
                         IRanges(start = atac_peaks$Start, end = atac_peaks$End))

sig_genes_gr <- genes[which(genes$gene_id %in% sig_genes$gene_id)]

sig_genes_gr_region <- resize(sig_genes_gr, width = width(sig_genes_gr) + 1e6, fix = "center")
width(sig_genes_gr_region)
num_atac_peaks_overlapped <- data.frame(countOverlaps(sig_genes_gr_region, atac_peaks_gr)) %>%
  rownames_to_column("gene_id") %>%
  merge(g2s)

ov_list <- findOverlaps(sig_genes_gr_region, atac_peaks_gr)

atac_peaks$matching_fr_gene_id <- NA
atac_peaks$matching_fr_gene_id[ov_list@to] <- sig_genes_gr_region$gene_id[ov_list@from]

atac_peaks$matching_fr_gene_name <- NA
atac_peaks$matching_fr_gene_name[ov_list@to] <- sig_genes_gr_region$gene_name[ov_list@from]

ggplot(atac_peaks, aes(x = log2FoldChange, y = -log10(pvalue))) + geom_point() + 
  geom_text_repel(data = atac_peaks %>% filter(!is.na(matching_fr_gene_name)), aes(label = matching_fr_gene_name))

ov_atac <- num_atac_peaks_overlapped %>% filter(countOverlaps.sig_genes_gr_region..atac_peaks_gr. > 0)
hmm <- sig_genes %>% filter(gene_id %in% ov_atac$gene_id)
?shift
```


```{r}
# Let's plot the vs zero fold changes
res_vszero <- resdf %>% filter(comparison == "vs_zero")

res_vszero <- res_vszero %>%
  mutate(timepoint = gsub("timepoint_minutes_", "", result_name),
         timepoint = gsub("_vs_0", "", timepoint),
         timepoint = as.numeric(timepoint))

esc_res_vszero <- res_vszero %>%
  filter(cell_type == "ESC")

ggplot(res_vszero, aes(x = timepoint, y = log2FoldChange)) + 
  geom_point()
table(res_vszero$result_name)

# g2 <- ggplot(sresdf, aes(x = x_bm, y = log2FoldChange, color = point_color, group = gene_id, text = paste("gene_name:", gene_name)))
# g2 <- g2 + 
#   # stat_smooth(geom = "line", aes(group = gene_id), data = sresdf %>% filter(isDE != "0"),
#   #           color = "#7F7F7F", alpha = 0.3, se = F, method = "loess", span = 0.15, size = 0.2) +
#     geom_line(aes(group = gene_id), data = sresdf %>% filter(isDE != "0"),
#             color = "#7F7F7F", alpha = 0.3, size = 0.2) +
#   geom_hline(yintercept = 0, size = 2, color = "white") +
#   geom_point(alpha = 0.7, data = sresdf %>% filter(DE == "1" | DE == "-1"), size = 2) + 
#   geom_point(alpha = 0.1, data = sresdf %>% filter(DE == "0") %>% sample_n(5e3), color = "#f2f2f2") +
#   scale_x_continuous(breaks = c(seq(30,330,30),seq(400,550,50)),
#                      labels = c(paste0(seq(30,330,30), "m"), "12h", "24h", "48h", "96h")) +
#   xlab("Timepoint") +
#   ggtitle("Firre induction vs. control") +
#   scale_color_identity(guide = FALSE)

```


#### Independent filtering

Something is kind of wonky with the independent filtering cutoff for NPC WT
I think it could be because not much is changing in that data or 
because Dox is causing a lot of changes, but DEseq2 has set really 
high filterThreshold.

For that reason, I will run the experiments without filtering in
DESeq2 and then filter at a filterThreshold of 100 baseMean counts.

| ORIGINAL DESEQ2 filterThresholds |
|----------------------------------|
| NPC WT = 969.99 |
| NPC KO = 0 |
| ESC WT = 3.35 |
| ESC KO = 79.98 |

For more on independent filtering, see: 
[DEseq2 vignette: independent filtering](http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#independent-filtering-of-results)

```{r independent_filtering}
# Select a new independent filtering baseMean cutoff
resdf$pvalue[resdf$baseMean < 100] <- NA
resdf$padj <- NA

# Also, since these are independent experiments
# and since DEseq2 would typically do multiple
# hypothesis testing for each experiment indivudally
# we'll apply the testing correction per experiment
# here as well.
resdf <- resdf %>% group_by(cell_type, firre_ko) %>%
  mutate(padj = p.adjust(pvalue, method="BH"))
```

### P-value histogram

The pvalue histogram appears to be bimodal with a large number of p-values 
near 1. This would indicate that the test that we have is not the ideal 
statistical test. However, theoretically it is a good test for the question
we're trying to answer and Generalized linear models (GLM) as well as a 
likelihood ratio test with a full and reduced formula remains the gold standard
for this sort of analysis [ref](https://academic.oup.com/bib/article/20/1/288/4364840).
One alternative to explore is [impulseDE2](https://bioconductor.org/packages/release/bioc/vignettes/ImpulseDE2/inst/doc/ImpulseDE2_Tutorial.html).

```{r pval_hist, message=FALSE}
# First let's check out the distribution of p-values
g <- ggplot(resdf, aes(x = pvalue)) 
g + geom_histogram() + facet_grid(cell_type~firre_ko) +
  theme_paperwhite() + 
  ggtitle("p-value histogram")

# One possibility is that we've got 
# a bunch of pvalues with really low counts
# At the upper end of the p-value scale
g <- ggplot(resdf, aes(x = log10(baseMean), color = pvalue > 0.9))
g + geom_density() + 
  ggtitle("p-value > 0.9 baseMean distribution") + 
  theme_paperwhite()
# Looks like that is not the case. 
# One other thing that we could do is plot some of the 
# profiles of these genes that have pval close to 1 
# to look at what might be going on.
```

### Threshold DEGs

We'll look at the number of DEGs for a few different cutoffs.

```{r pval_thresholds}
sig_summary <- resdf %>% 
  mutate(pthresh_01 = padj < 0.01,
         pthresh_05 = padj < 0.05,
         pthresh_10 = padj < 0.10) %>%
  dplyr::select(gene_id, gene_name, cell_type, firre_ko,
                pthresh_01, pthresh_05, pthresh_10) %>%
  unite("experiment", cell_type, firre_ko) %>%
  group_by(experiment) %>%
  distinct() %>%
  summarize(pthresh_01 = length(which(pthresh_01 == TRUE)),
            pthresh_05 = length(which(pthresh_05 == TRUE)),
            pthresh_10 = length(which(pthresh_10 == TRUE))) %>%
  pivot_longer(cols = 2:4, names_to = "pthreshold",
               values_to = "num_DEG") %>%
  mutate(pthreshold = gsub("pthresh_", "", pthreshold),
         pthreshold = as.numeric(pthreshold)/100)
knitr::kable(sig_summary)
ggtexttable(sig_summary)

g <- ggplot(sig_summary, aes(x = experiment, y = num_DEG, fill = factor(pthreshold)))
g + geom_bar(stat = "identity", position = "dodge") + 
  scale_fill_manual(values = c("#424242","#a8404c","#71969F")) +
  ggtitle("DEG count")
```


Here we'll make a cutoff at padj < 0.05 and look at the overlap between
experiments. It looks like despite very few gene changing in the NPC KO
condition there are still some that overlap with the other conditions.
It is a good sanity check that Firre is overlapping in all four experiments.
Notably, ADGRG1 is also overlapping in all. Shf is overlapping 
in three conditions and this was one of the early responders as noted
in previous analyses.

```{r sig_deg}
pthresh <- 0.1

sig_matrix <- resdf %>% 
  filter(padj < pthresh) %>%
  dplyr::select(gene_id, gene_name, cell_type, firre_ko) %>%
  unite("experiment", cell_type, firre_ko) %>%
  mutate(sig = 1) %>%
  distinct() %>%
  pivot_wider(names_from = experiment, values_from = sig, values_fill = 0) %>%
  dplyr::select(-gene_id) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

sigdf <- sig_matrix %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_name")
names(sigdf)[2:5] <- paste0(names(sigdf)[2:5], "_padj0.05")
## Output convenient results table
firre_responders_df <- resdf %>% 
  filter(gene_name %in% sigdf$gene_name) %>%
  get_dynamic_comparison_df() %>%
  unite("experiment", cell_type, firre_ko) %>%
  group_by(gene_name, gene_id, experiment) %>%
  mutate(max_abs_lfc = max(abs(log2FoldChange)),
         max_timepoint = timepoint[which.max(abs(log2FoldChange))] %>%
           as.character() %>% as.numeric()) %>%
  dplyr::select(gene_id, gene_name, experiment,
                padj, max_abs_lfc, max_timepoint) %>%
  distinct() %>%
  pivot_wider(id_cols = c("gene_id", "gene_name"),
              names_from = experiment, values_from = c("padj", "max_abs_lfc",
                                                       "max_timepoint")) %>%
  merge(sigdf) %>%
  dplyr::select(gene_id, gene_name, ESC_KO_padj0.05, ESC_WT_padj0.05,
                NPC_KO_padj0.05, NPC_WT_padj0.05, everything()) %>%
  arrange(-ESC_KO_padj0.05, -ESC_WT_padj0.05,
                -NPC_KO_padj0.05, -NPC_WT_padj0.05)
write_csv(firre_responders_df, "results/firre_induced_genes.csv")

write_csv(sigdf, "results/deg_firre_induced_vs_control.csv")

gplots::venn(sig_matrix, simplify = TRUE)

pdf("figures/venn.pdf")
gplots::venn(sig_matrix, simplify = TRUE)
dev.off()
```

## Time LFC Plot

Here we'll plot the fold-changes (GLM coefficients) for the interaction term
which corresponds to Firre induction vs control through time. This will 
give us some idea of the trends that the genes are following that are Firre 
responders.

It appears that most of the genes are moving in a consistent direction
and not transiently responding. It may be that the GLM / LRT method used
is better at indentifying these types of trends rather than transiently 
changing genes. For completeness, I will analyze individual timepoints
in a pairwise manner to get a list of genes that are changing transiently.

It seems that our overlapping genes also are toward the top of the
range in terms of fold-change. Overall the fold-changes are quite small. 
I suppose this is because we're on a relatively short time scale.
It will be interesting to see what the effect size grows to in the longer
timecourse.

```{r time_lfc_plot}
# Here we'll retrieve the lfc values for just
# the dynamic firre induced vs control comparison (the interaction term).
sig_dyn <- resdf %>%
  get_dynamic_comparison_df() %>%
  filter(padj < 0.05) %>%
  group_by(gene_id, gene_name, cell_type, firre_ko) %>%
  mutate(max_lfc = log2FoldChange[which.max(abs(log2FoldChange))],
         max_abs_lfc = max(abs(log2FoldChange)))

## We're having a lot of really small fold-changes here.
# Let's calculate the max lfc and filter on that
sig_max_lfc <- sig_dyn %>%
  dplyr::select(gene_id, gene_name, cell_type, 
                firre_ko, max_lfc, max_abs_lfc) %>%
  distinct()

g <- ggplot(sig_max_lfc, aes(x = max_abs_lfc))
g + geom_histogram(bins = 40) + 
  theme_paperwhite() + 
  xlim(0,2) +
  ggtitle("Max magnitude fold-change")

sig_dyn <- sig_dyn %>% filter(max_abs_lfc > 0.5)
# Let's label the two genes with the highest fold-changes in the
# last time point.
ltp <- sig_dyn %>% filter(timepoint == 330 | timepoint == 360) %>%
  arrange(-abs(log2FoldChange)) %>%
  group_by(cell_type, firre_ko) %>%
  dplyr::slice(1:4)

g <- ggplot(sig_dyn, aes(x = timepoint, y = log2FoldChange, group = gene_name))
g + geom_hline(yintercept = 0) +
  geom_point(alpha = 0.7) + 
  geom_line(color = "#424242", alpha = 0.2) + 
  facet_wrap(cell_type~firre_ko, scales = "free_y") +
  theme_paperwhite() +
  geom_text_repel(data = ltp,
                  aes(label = gene_name))
```

### Individual profile plots

Here we'll plot the TPMs of each significant gene through time for all four
experiments.

Some of these genes may be changing due to the stochastic effects of the Dox
response. In other words, they may not be Firre responders per se, but
rather, in the Firre induced condition, the cascade of gene expression
changes resulting from Dox could have taken a different path. Therefore,
taking the overlap between conditions is a nice way to control for this.
One alternative is to filter out any genes that are changing at all in response
to Dox, but this may get rid of some genes that are true Firre responders,
but are also responsive to Dox (i.e. in a different direction).

```{r gene_profile_plots}
plot_gene_profiles <- FALSE

genes_overlapping_esc <- sig_dyn %>% 
  dplyr::select(gene_id, gene_name, cell_type, firre_ko) %>%
  unite("experiment", cell_type, firre_ko) %>%
  mutate(sig = 1) %>%
  distinct() %>%
  pivot_wider(names_from = experiment, values_from = sig, values_fill = 0) %>%
  dplyr::select(-gene_id) %>%
  filter(ESC_KO == 1, ESC_WT == 1)


if(plot_gene_profiles == TRUE) {
  
  dir.create("figures/gene_profile_plots", showWarnings = FALSE)
  
  genes_to_plot <- unique(genes_overlapping_esc$gene_id)
  # genes_to_plot <- c("ENSMUSG00000035299.16", "ENSMUSG00000032679.12",
  #                    "ENSMUSG00000064360.1")
  
  for(i in 1:length(genes_to_plot)) {
    
    goi <- genes_to_plot[i]
    gene_name <- g2s$gene_name[g2s$gene_id == goi]
    
    gene_stats <- resdf %>% 
      filter(gene_id %in% genes_to_plot) %>%
      dplyr::select(gene_id, gene_name, cell_type, 
                    firre_ko, padj, log2FoldChange) %>%
      group_by(gene_id, gene_name, cell_type, firre_ko, padj) %>%
      summarize(max_abs_l2fc = log2FoldChange[which.max(abs(log2FoldChange))]) %>%
      mutate(padj = paste0("padj = ", signif(padj, digits = 3)))
    
    goi_stats <- gene_stats %>% filter(gene_id == goi)
    
    tpm_goi <- tpm %>% filter(gene_id == goi) %>%
      pivot_longer(3:ncol(.), names_to = "sample_id",
                   values_to = "tpm") %>%
      merge(samples) %>%
      unite("condition", cell_type, firre_ko, firre_induced, sep = ";",
            remove = FALSE)
    
    res_goi <- resdf %>% filter(gene_id == goi)
    
    g_tpm <- ggplot(tpm_goi, aes(x = timepoint, y = tpm)) + 
      geom_point(aes(color = firre_induced)) + 
      geom_smooth(aes(group = condition, color = firre_induced), method = "loess", 
                  formula = "y ~ x", se = FALSE) +
      facet_grid(cell_type~firre_ko, scales = "free_y") +
      ggtitle(gene_name) +
      theme_paperwhite() + 
      geom_text(data = goi_stats,  aes(x=Inf, y = Inf, 
                                       label = padj), 
                vjust=1.5, hjust=1.1) + 
      theme(legend.title = element_blank(),
            legend.position="bottom")
    
    
    # Label the comparisons
    
    res_goi_dynamic <- res_goi %>% 
      filter(comparison == "dynamic_firre_induction_vs_control") 
    res_goi_dynamic$timepoint <- sapply(res_goi_dynamic$result_name,
                                        function(x) {
                                          x <- gsub("timepoint", "", x)
                                          gsub(".firre_inducedfirre_induced", "", x,
                                               fixed = T)
                                        }) %>%
      as.numeric()
    res_goi_dynamic$timepoint <- factor(res_goi_dynamic$timepoint, 
                                        levels = seq(30,360,30))
    g_fc <- ggplot(res_goi_dynamic, aes(y = log2FoldChange, x = timepoint)) + 
      geom_segment( aes(x= timepoint, xend= timepoint, y=0, yend=log2FoldChange)) +
      geom_point() + 
      geom_hline(yintercept = 0) +
      facet_grid(cell_type~firre_ko) + 
      theme_paperwhite() +
      ggtitle("Dynamic Firre induction vs control")
    
    
    res_goi_vs_zero <- res_goi %>% filter(comparison == "vs_zero")
    res_goi_vs_zero$timepoint <- sapply(res_goi_vs_zero$result_name,
                                        function(x) {
                                          unlist(strsplit(x,"tes_"))[[2]]
                                        })
    res_goi_vs_zero$timepoint <- factor(res_goi_vs_zero$timepoint, 
                                        levels = paste0(seq(30,360,30),"_vs_0"))
    
    g_fczero <- ggplot(res_goi_vs_zero, aes(x = timepoint, y = log2FoldChange)) + 
      geom_hline(yintercept = 0) +
      geom_segment(aes(x= timepoint, xend= timepoint, y=0, yend=log2FoldChange)) +
      geom_point() +
      facet_grid(cell_type~firre_ko) + 
      theme_paperwhite() + 
      ggtitle("Comparison to zero timepoint")
    
    res_static <- res_goi %>% 
      filter(comparison == "static_firre_induction_vs_control") %>%
      unite("experiment", cell_type, firre_ko, remove = F)
    g_static <- ggplot(res_static, aes(x = experiment, y = log2FoldChange)) + 
      geom_hline(yintercept = 0) +
      geom_segment( aes(x= experiment, xend= experiment, y=0, yend=log2FoldChange)) +
      geom_point() + 
      theme_paperwhite() +
      ggtitle("Static Firre induction vs control")
    
    
    ## Assemble
    ggarrange(g_tpm, g_fc, g_fczero, g_static)
    ggsave(paste0("figures/gene_profile_plots/", gene_name, ".png"),
           width = 12, height = 10)
  }
}
```

## Long timecourse plots

```{r}

samples <- read.csv("../../rnaseq/rnaseq_samplesheet.csv") %>%
  filter(cell_type != "pMEF",
         date_sequenced != "2018-09") %>%
  mutate(firre_ko = factor(firre_ko, levels = c("WT", "KO")),
         timepoint = factor(timepoint, 
                                    levels = c(seq(0,360,30), 720, 1440, 2880, 5760)),
         firre_induced = factor(firre_induced, 
                                levels = c("control", "firre_induced")))
rownames(samples) <- samples$sample_id


goi <- genes_to_plot[1]
gene_name <- g2s$gene_name[g2s$gene_id == goi]
gene_id <- goi

gene_stats <- resdf %>% 
  filter(gene_id %in% genes_to_plot) %>%
  dplyr::select(gene_id, gene_name, cell_type, 
                firre_ko, padj, log2FoldChange) %>%
  group_by(gene_id, gene_name, cell_type, firre_ko, padj) %>%
  summarize(max_abs_l2fc = log2FoldChange[which.max(abs(log2FoldChange))]) %>%
  mutate(padj = paste0("padj = ", signif(padj, digits = 3)))
goi_stats <- gene_stats %>% filter(gene_id == goi)

tpm_goi <- tpm %>% filter(gene_id == goi) %>%
      pivot_longer(3:ncol(.), names_to = "sample_id",
                   values_to = "tpm") %>%
      merge(samples) %>%
      unite("condition", cell_type, firre_ko, firre_induced, sep = ";",
            remove = FALSE)
tpm_goi$timepoint

g_tpm <- ggplot(tpm_goi, aes(x = timepoint, y = tpm)) + 
      geom_point(aes(color = firre_induced)) + 
      geom_smooth(aes(group = condition, color = firre_induced), method = "loess", 
                  formula = "y ~ x", se = FALSE) +
      facet_grid(cell_type~firre_ko, scales = "free_y") +
      ggtitle(gene_name) +
      theme_paperwhite() + 
      geom_text(data = goi_stats,  aes(x=Inf, y = Inf, 
                                       label = padj), 
                vjust=1.5, hjust=1.1) + 
      theme(legend.title = element_blank(),
            legend.position="bottom")
g_tpm
```

# Let's cluster profiles for ESC KO firre induced samples

```{r}
# It might me best to use rld counts for this, but for now we'll start with TPMs
esc_ko_samples <- samples %>% 
  filter(cell_type == "ESC", firre_ko == "KO",
         firre_induced == "firre_induced")
esc_ko_tpm <- tpm[,c("gene_id", esc_ko_samples$sample_id)] %>%
   pivot_longer(2:ncol(.), names_to = "sample_id",
                   values_to = "tpm") %>%
      merge(esc_ko_samples) %>%
      unite("condition", cell_type, firre_ko, firre_induced, sep = ";",
            remove = FALSE)
esc_ko_tpm <- esc_ko_tpm %>% group_by(gene_id, timepoint) %>%
  summarize(mean_tpm = mean(tpm, na.rm = T))
esc_ko_tpm_matrix <- esc_ko_tpm %>%
  pivot_wider(id_cols = "gene_id", names_from = timepoint,
              values_from = mean_tpm, names_prefix = "tp_") %>%
  column_to_rownames("gene_id") %>%
  as.matrix()
esc_ko_tpm_matrix <- esc_ko_tpm_matrix[rowSums(esc_ko_tpm_matrix) > 1,]
library(pheatmap)
?sample
pheatmap(esc_ko_tpm_matrix[sample(1:nrow(esc_ko_tpm_matrix), 8e3),], 
         cluster_cols = FALSE,
         show_rownames = FALSE, scale = "row",
         kmeans_k = 30)

esc_ko_tpm_scaled <- t(scale(t(esc_ko_tpm_matrix)))

kclus <- kmeans(esc_ko_tpm_scaled, 
                center = 30, nstart = 25)
kclus_centers <- kclus$centers %>% as.data.frame() %>%
  rownames_to_column("cluster") %>%
  pivot_longer(cols = 2:ncol(.), names_to = "timepoint", values_to = "y")
kclus_centers$timepoint <- factor(kclus_centers$timepoint, 
              levels = paste0("tp_",c(seq(0,360,30), 720, 1440, 2880, 5760)))
g <- ggplot(kclus_centers, aes(x = timepoint, y = y, group = cluster))
g + geom_point() + geom_line() + facet_wrap(cluster~.)





```




### Heatmap

```{r}
# Let's just plot those that are shared in ESC
esc_fr <- firre_responders_df %>%
  filter(ESC_KO_padj0.05 == 1,
         ESC_WT_padj0.05 == 1)
esc_fr_lfc <- resdf %>% 
  filter(gene_id %in% esc_fr$gene_id,
         cell_type =="ESC",
         grepl(".firre_inducedfirre_induced", result_name))
esc_fr_lfc$timepoint <- gsub("timepoint", "tp_", esc_fr_lfc$result_name)
unique(esc_fr_lfc$timepoint)
esc_fr_lfc$timepoint <- gsub(".firre_inducedfirre_induced", "", esc_fr_lfc$timepoint)
esc_fr_lfc$timepoint <- factor(esc_fr_lfc$timepoint, levels =
                                         paste0("tp_", seq(30,330,30)))

esc_fr_matrix_ko <- esc_fr_lfc %>%
  as.data.frame() %>%
  filter(firre_ko == "KO") %>%
  dplyr::select(gene_name, log2FoldChange, timepoint) %>%
  pivot_wider(names_from = timepoint, values_from = log2FoldChange) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

esc_fr_matrix_wt <- esc_fr_lfc %>%
  as.data.frame() %>%
  filter(firre_ko == "WT") %>%
  dplyr::select(gene_name, log2FoldChange, timepoint) %>%
  pivot_wider(names_from = timepoint, values_from = log2FoldChange) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()


fcscaled_ko <- esc_fr_matrix_ko %>%
  t() %>%
  scale(center = FALSE) %>%
  t()
library(stats)
fcsmoothed_ko <- apply(fcscaled_ko,1,smooth) %>% t()
rownames(fcsmoothed_ko) <- rownames(esc_fr_matrix_ko)
library(pheatmap)
pdf("firre_responders_esc_ko.pdf", height = 10, width = 7)
pheatmap(fcsmoothed_ko, cluster_cols = FALSE, 
         breaks = seq(-2,2,length.out = 100),
         cutree_rows = 10,
         color = rev(pals::brewer.rdbu(100)),
         border_color = NA)
dev.off()

fcscaled_wt <- esc_fr_matrix_wt %>%
  t() %>%
  scale(center = FALSE) %>%
  t()

fcsmoothed_wt <- apply(fcscaled_wt,1,smooth) %>% t()
rownames(fcsmoothed_wt) <- rownames(esc_fr_matrix_wt)
pdf("firre_responders_esc_wt.pdf", height = 10, width = 7)
pheatmap(fcsmoothed_wt, cluster_cols = FALSE, 
         breaks = seq(-2,2,length.out = 100),
         cutree_rows = 10,
         color = rev(pals::brewer.rdbu(100)),
         border_color = NA)
dev.off()

```




